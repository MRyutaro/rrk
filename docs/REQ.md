# 概要
**rrk**（rireki）は、Go製の単一バイナリCLIツールで、bash/zshのシェル履歴を  
- **セッション**・**ディレクトリ**単位で論理的にグループ化  
- 過去のコマンドを「**そのまま再実行可能**」な形で抽出し、簡単に呼び出せる履歴管理を提供  

といった形で管理・検索・再実行を支援します。

# 背景
- 標準のbash/zsh履歴は全履歴を一元化しており、特定セッションや作業ディレクトリに絞り込めない  
- プロジェクト移行やディレクトリ構成変更時に履歴中の`cd /old/path`がエラーになるなど、過去コマンドの再利用に手間がかかる  
- Atuinやfzf-historyなど多くのツールが「検索性」や「同期機能」に注力する一方、**再実行性の手軽さ**や**論理グループ化**まで踏み込んだ支援機能は未実装  
- サーバ用途でも使いやすいよう、「依存ライブラリ不要」「単一バイナリ配布」「初回対話セットアップ」で非エキスパートでも導入可能なCLIツールが求められている  

# 実装済み機能

## 1. 基本コマンド

### 履歴管理
- `rrk list` - 全コマンド履歴を一覧表示（`-n`オプションで制限可能）
- `rrk rerun <HIST_ID>` - 指定した履歴エントリを元のディレクトリで再実行

### セッション管理
- `rrk session list` (または `rrk s list`) - 過去のセッションID一覧を表示
- `rrk session show [session_id]` (または `rrk s show`) - セッション履歴を表示
  - 引数なしまたは`current`で現在のセッション履歴
  - セッションIDを指定で特定セッションの履歴

### ディレクトリ管理
- `rrk dir show [directory|dir-id]` (または `rrk d show`) - ディレクトリ履歴を表示
  - 引数なしで現在のディレクトリ
  - パスまたはディレクトリIDで指定可能
- `rrk dir list` (または `rrk d list`) - 履歴を持つディレクトリ一覧（ID付き）

## 2. シェル統合

### 自動セットアップ
- `rrk setup` - シェル統合の自動セットアップ（`-y`オプションで自動確認）
- bash/zsh対応のフック機能で自動履歴記録
- `~/.bashrc`/`~/.zshrc`への統合設定追加

### 手動統合
- `rrk hook init <shell>` - シェル統合スクリプトを出力
- `rrk hook record <command>` - コマンドを手動で履歴に記録
- `rrk hook session-init` - 新しいセッションIDを初期化

## 3. ユーティリティ

### バージョン・アップデート
- `rrk version` - バージョン情報表示
- `rrk update` - 最新バージョンへの自動アップデート
- 自動アップデート通知機能（24時間間隔でチェック）

### アンインストール
- `rrk uninstall` - シェル統合と全データの削除（`-y`で自動確認）

# 履歴保存仕様

## データ保存先
- 履歴データは `~/.rrk/` ディレクトリ以下に保存（隠しディレクトリ）
- `~/.rrk/history.jsonl` - JSONL形式での履歴保存
- `~/.rrk/current_session` - 現在のセッションID
- `~/.rrk/hook.sh` - シェル統合スクリプト
- `~/.rrk/.rrk_version_cache` - バージョンチェックキャッシュ

## 履歴エントリ構造
各履歴エントリは以下の情報を保持：
- `id`: 自動採番される一意な整数（1から順に付番）  
- `session_id`: 同一セッションを示す文字列（ホスト名_PID_タイムスタンプ）  
- `cwd`: 実行時のカレントディレクトリ（パス）  
- `command`: 実行されたコマンド（cdコマンドは記録対象外）
- `timestamp`: 実行時刻（RFC3339形式）

## シェル統合
- PROMPT_COMMAND（bash）またはprecmdフック（zsh）を使用
- `history`コマンド（bash）または`fc -ln -1`（zsh）で最新コマンドを取得
- 非同期処理でシェルパフォーマンスへの影響を最小化

## 既知の問題
- **zshでの改行文字混入**: `fc -ln -1`が改行文字を含む場合がある（未修正）
  - 影響：コマンド履歴に`\n`が記録される
  - 対策：zshフック部分での文字列処理改善が必要

# CI/CD・リリース自動化

## GitHub Actions
- **PR→mainマージ時**: 自動パッチバージョンアップ + リリース作成
- **手動タグプッシュ時**: リリース作成
- **マルチプラットフォームビルド**: Linux/macOS/Windows (AMD64/ARM64)

## バージョン管理
- セマンティックバージョニング
- `make patch/minor/major` - ローカルでのバージョンアップ
- `scripts/bump-version.sh` - バージョン管理スクリプト

## ワークフロー構成
- `.github/workflows/auto-patch.yml` - PRマージ時の自動パッチリリース
- `.github/workflows/release-on-tag.yml` - タグプッシュ時のリリース
- `.github/workflows/release.yml` - 共通リリース処理（再利用可能）

# 技術仕様

## 非機能要件（達成済み）
- ✅ **データベース不要** - JSONL形式でのファイルベース管理
- ✅ **クロスプラットフォーム** - Linux/macOS/Windows対応  
- ✅ **単一バイナリ** - Go製静的リンクバイナリ
- ✅ **低オーバーヘッド** - 非同期履歴記録
- ✅ **自動アップデート** - GitHub Releasesからの自動更新
- ✅ **ヘルプ充実** - 全コマンドでhelp対応
- ✅ **クリーンアンインストール** - データ削除機能付き

## 開発環境
- **言語**: Go 1.22+
- **依存**: cobra（CLI）、標準ライブラリのみ
- **ビルド**: Makefile + GitHub Actions
- **配布**: GitHub Releases

## アーキテクチャ
```
rrk/
├── main.go              # エントリーポイント
├── cmd/                 # CLI コマンド実装
│   ├── root.go         # ルートコマンド
│   ├── list.go         # 履歴一覧
│   ├── session.go      # セッション管理
│   ├── dir.go          # ディレクトリ管理
│   ├── rerun.go        # 再実行
│   ├── hook.go         # シェル統合
│   ├── setup.go        # セットアップ
│   ├── update.go       # アップデート
│   ├── uninstall.go    # アンインストール
│   ├── version.go      # バージョン情報
│   └── utils.go        # ユーティリティ
├── internal/           # 内部ライブラリ
│   ├── history/        # 履歴エントリ定義
│   ├── storage/        # ストレージ操作
│   ├── session/        # セッション管理
│   └── updater/        # アップデート機能
└── scripts/            # ビルドスクリプト
    └── bump-version.sh # バージョン管理
```

# 設計原則

## ユーザビリティ
- **学習コストの最小化**: 直感的なコマンド体系
- **エラー処理の充実**: 分かりやすいエラーメッセージ
- **一貫性**: 全コマンドで統一されたインターフェース

## 保守性
- **テスト可能性**: 単体テスト可能な設計
- **モジュール化**: 機能別の明確な分離
- **ドキュメント**: コメントの日本語化（開発者向け）

## 拡張性
- **プラグイン対応**: 将来のプラグインシステム考慮
- **設定可能性**: ユーザー設定のサポート
- **API設計**: 内部APIの安定性確保